# WG-Desktop: 开发与部署指南 (V5.0)

本文档将指导您完成 `wg-desktop` 项目的本地开发环境配置、编码实现步骤以及本地部署流程。

## 1. ✅ 方案可行性

您设计的技术方案**完全可行**，且具备良好的工程实践基础：

*   **架构清晰**: 前后端分离（Vue + FastAPI）的模式有利于独立开发和维护。
*   **技术栈现代**: FastAPI 和 Vue 3 是构建高性能、现代化 Web 应用的优秀选择。
*   **挑战预见性**: 方案已准确识别并解决了核心挑战，即 `wg.py` 的模块化重构与后端异步I/O处理。

---

## 2. 🛠️ 阶段一：环境与依赖部署

在开始编码前，请确保您的开发环境已配置好以下依赖。

### 2.1 系统级依赖 (核心引擎)

这是 `wg.py` 脚本运行的基础。

*   **Git**: 必须安装并可在系统的 `PATH` 中访问。
    *   *验证*: 在终端运行 `git --version`。
*   **Pandoc**: 用于 `.docx` 内容转换和差异比较的关键工具。
    *   *验证*: 在终端运行 `pandoc --version`。

### 2.2 后端环境 (Python / FastAPI)

*   **Python**: 建议使用 `Python 3.8` 或更高版本。
*   **创建 Python 虚拟环境**: 在项目根目录 (`gitudoc/`) 下执行，以隔离项目依赖。
    ```bash
    # 创建虚拟环境文件夹 venv
    python3 -m venv venv

    # 激活虚拟环境 (macOS/Linux)
    source venv/bin/activate
    # (Windows 使用: venv\Scripts\activate)
    ```
*   **安装 Python 依赖库**:
    ```bash
    # 确保虚拟环境已激活
    # 安装 FastAPI, Uvicorn 服务器及所有推荐依赖
    pip install "fastapi[all]"
    ```

### 2.3 前端环境 (Node.js / Vue)

*   **Node.js**: 安装最新的 LTS (长期支持) 版本，它将自动包含 `npm`。
    *   *验证*: 在终端运行 `node -v` 和 `npm -v`。
*   **创建 Vue 项目 (如果尚未创建)**: 使用官方脚手架 `create-vue`。
    ```bash
    # 在 gitudoc/ 目录下 (或您选择的位置)
    # 按照提示创建一个名为 wg-frontend 的 Vue 3 项目
    npm create vue@latest wg-frontend
    ```
*   **安装前端依赖**: 进入新创建的前端项目目录并安装文档中提到的库。
    ```bash
    cd wg-frontend

    # 安装 axios (API 请求), Pinia (状态管理), 和 vue-diff (差异视图)
    npm install axios pinia vue-diff
    ```

---

## 3. ⌨️ 阶段二：编码实现步骤

环境就绪后，建议遵循以下顺序进行开发。

1.  **重构 `wg.py` (首要任务)**
    *   **目标**: 将其改造为一个可导入、支持多项目的 Python "库"。
    *   **关键操作**:
        1.  确保所有 argparse 和 `main()` 调用都在 `if __name__ == "__main__":` 保护块内 (已完成)。
        2.  **（核心升级）**所有 `handle_*` 函数（如 `handle_init`, `handle_status`）都必须接受一个新的 `project_path: str` 参数。
        3.  **（核心升级）**`run_command` 函数必须接受 `cwd` 参数并传递给 `subprocess.run`，以确保 `git` 命令在正确的目录下执行。
        4.  修改 `handle_diff`, `handle_status` 等查询类函数，使其 `return` 数据，而不是 `print()`。
        5.  修改 `handle_commit`, `handle_restore` 等操作类函数，使其在成功时 `return True`，失败时 `raise Exception`。

2.  **开发 FastAPI 后端 (`main.py`)**
    *   **目标**: 提供管理项目和执行 `wg` 操作的 API 接口。
    *   **关键操作**:
        1.  创建 `main.py` 文件并 `import wg`。
        2.  **（新增）项目管理**: 实现 `GET /api/projects` 和 `POST /api/projects` 端点，用于读取和写入 `projects.json` 文件，并在添加项目时调用 `wg.handle_init`。
        3.  **（升级）核心功能 API**: 修改所有旧的 API 端点（`/api/status`, `/api/diff/...` 等），使其**必须接受一个 `project_path` 查询参数**。
        4.  在所有核心功能端点中，使用 `await run_in_threadpool(wg.function, project_path, ...)` 来安全地调用 `wg` 函数。
        5.  务必配置 CORS 中间件，以允许前端开发服务器的跨域请求。

3.  **开发 Vue.js 前端 (`wg-frontend/`)**
    *   **目标**: 创建一个允许用户选择项目并管理版本的图形界面。
    *   **关键操作**:
        1.  **（新增）项目选择器**: 创建 `ProjectSelector.vue` 作为应用的入口视图，用于显示项目列表和添加新项目。
        2.  **（重构）状态管理**: 创建 `stores/useProjectsStore.js` (Pinia)，统一管理项目列表 (`projects`)、当前活动项目 (`activeProject`) 以及该项目下的文件状态 (`changedFiles`, `selectedFile` 等)。
        3.  **（新增）条件渲染**: 在 `App.vue` 中，根据 Pinia store 中的 `activeProject` 是否存在，来决定渲染 `ProjectSelector.vue` 还是包含所有核心功能的 `Dashboard.vue` 视图。
        4.  **（升级）组件**: 确保 `ChangesList`, `DiffView`, `CommitBox` 等组件的所有 API 调用都从 store 获取 `activeProject` 路径，并将其作为参数发送给后端。

---

## 4. 🚀 本地部署与运行

在开发过程中，您需要同时启动前端和后端两个服务。

1.  **启动后端 FastAPI 服务**:
    *   确保您位于项目根目录 (`gitudoc/`) 并且 Python 虚拟环境已激活。
    *   运行 Uvicorn 服务器 (假设您的 FastAPI app 实例在 `main.py` 中名为 `app`)。
    ```bash
    # --reload 会在代码变更时自动重启服务
    # --port 指定服务端口
    uvicorn main:app --reload --port 8000
    ```
    *   API 服务将运行在 `http://localhost:8000`。

2.  **启动前端 Vue 开发服务**:
    *   打开一个新的终端窗口。
    *   进入前端项目目录 (`gitudoc/wg-frontend/`)。
    *   运行开发服务器。
    ```bash
    npm run dev
    ```
    *   前端应用将运行在 `http://localhost:5173` (或终端提示的其他端口)。

现在，您可以在浏览器中打开前端地址。应用启动后，您将首先看到**项目选择器界面**。添加或选择一个项目后，才会进入文件管理仪表盘。
